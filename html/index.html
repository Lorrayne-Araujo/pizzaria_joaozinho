<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pizzaria do Joãonzinho</title>
    <!-- Bootstrap-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous"> 
    <!-- Font Awesome-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- App CSS-->
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div id="header"></div>
    <div id="main-banner">
        <h1>Faça seu pedido</h1>
    </div>
    <div id="main-container">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <h2>Monte a pizza como desejar:</h2>
                    <div id="message"></div>
                    <form action="process/pizza.html" method="post" id="pizza-form" onsubmit="enviarPedido(event)">
                        <div class="form-group">
                            <label for="borda">Borda:</label>
                            <select name="borda" id="borda" class="form-control">
                                <option value="">Selecione a borda</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="massa">Massa:</label>
                            <select name="massa" id="massa" class="form-control">
                                <option value="">Selecione a massa</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sabores">Sabores: (Máximo 3)</label>
                            <select multiple name="sabores[]" id="sabores" class="form-control">
                                <!-- Opções carregadas dinamicamente -->
                            </select>
                        </div>
                        <div class="form-group">
                            <input type="submit" class="btn btn-primary" value="Fazer Pedido" onsubmit="enviarPedido(event)">
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <script>
        fetch('../templates/header.html')
        .then(response => {
            if (!response.ok) {
                throw new Error('A resposta da rede não está ok');
            }
            return response.text();
        })
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const bodyContent = doc.body.innerHTML;
            document.getElementById('header').innerHTML = bodyContent;
        })
        .catch(error => {
            console.error('Erro ao carregar o header:', error);
            document.getElementById('header').innerHTML = '<p>Erro ao carregar o cabeçalho.</p>';
        });
        fetch('../templates/footer.html')
        .then(response => {
            if (!response.ok) {
                throw new Error('A resposta da rede não está ok');
            }
            return response.text();
        })
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const bodyContent = doc.body.innerHTML;
            document.getElementById('footer').innerHTML = bodyContent;
        })
        .catch(error => {
            console.error('Erro ao carregar o footer:', error);
            document.getElementById('footer').innerHTML = '<p>Erro ao carregar o rodapé.</p>';
        });
        
        async function carregarSabores() {
            try {
                const response = await fetch('http://localhost:3000/api/sabores');
                if (!response.ok) throw new Error('API não disponível');
                const sabores = await response.json();
                console.log('Sabores recebidos:', sabores);
                const select = document.getElementById('sabores');
                sabores.forEach(sabor => {
                    const option = document.createElement('option');
                    option.value = sabor.id;
                    option.textContent = sabor.tipo || sabor.nome;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar sabores:', error);
            }
        }

        async function carregarBordas() {
            try {
                const response = await fetch('http://localhost:3000/api/bordas');
                if (!response.ok) throw new Error('API não disponível');
                const bordas = await response.json();
                const select = document.getElementById('borda');
                select.innerHTML = '<option value="">Selecione a borda</option>';
                bordas.forEach(borda => {
                    const option = document.createElement('option');
                    option.value = borda.id;
                    option.textContent = borda.tipo || borda.nome;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar bordas:', error);
            }
        }

        async function carregarMassas() {
            try {
                const response = await fetch('http://localhost:3000/api/massas');
                if (!response.ok) throw new Error('API não disponível');
                const massas = await response.json();
                const select = document.getElementById('massa');
                select.innerHTML = '<option value="">Selecione a massa</option>';
                massas.forEach(massa => {
                    const option = document.createElement('option');
                    option.value = massa.id;
                    option.textContent = massa.tipo || massa.nome;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar massas:', error);
            }
        }

        // Carregar opções ao carregar a página
        window.addEventListener('DOMContentLoaded', function() {
            carregarSabores();
            carregarBordas();
            carregarMassas();

            if (window.innerWidth > 425) return;

            ativarSelectMobileQuandoTiverOpcoes('borda', 'Selecione a borda');
            ativarSelectMobileQuandoTiverOpcoes('massa', 'Selecione a massa');

        });

        function ativarSelectMobileQuandoTiverOpcoes(selectId, placeholder) {
            const select = document.getElementById(selectId);
            if (!select) return;

            const observer = new MutationObserver(() => {
                if (select.options.length > 1) {
                observer.disconnect();
                criarSelectMobile(selectId, placeholder);
                }
            });

            observer.observe(select, { childList: true });
        }

        function criarSelectMobile(selectId, placeholder) {
            const select = document.getElementById(selectId);
            if (!select) return;

            // evita duplicar se recarregar ou rodar duas vezes
            if (select.dataset.mobileCreated === 'true') return;
                select.dataset.mobileCreated = 'true';

                // esconder select original só no mobile
                select.classList.add('mobile-hide');

                const wrapper = document.createElement('div');
                wrapper.className = 'mobile-select-wrapper';

                const btn = document.createElement('div');
                btn.className = 'mobile-select-btn';
                btn.textContent = placeholder;

                const list = document.createElement('div');
                list.className = 'mobile-select-list';

                // cria a lista baseado nas options do select
                [...select.options].forEach(opt => {
                    if (!opt.value) return;

                    const item = document.createElement('div');
                    item.className = 'mobile-select-item';
                    item.textContent = opt.textContent;

                    item.addEventListener('click', () => {
                    select.value = opt.value;
                    btn.textContent = opt.textContent;

                    // dispara evento change (se seu código usa)
                    select.dispatchEvent(new Event('change'));

                    list.style.display = 'none';
                    });

                    list.appendChild(item);
                });

                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // fecha outros abertos
                    document.querySelectorAll('.mobile-select-list').forEach(l => {
                    if (l !== list) l.style.display = 'none';
                    });

                    list.style.display = list.style.display === 'block' ? 'none' : 'block';
                });

                wrapper.appendChild(btn);
                wrapper.appendChild(list);

                // coloca o select custom antes do select original
                select.parentNode.insertBefore(wrapper, select);

                // se já tiver value selecionado (ex: editando), mostra no botão
                if (select.value) {
                    const selectedOption = select.options[select.selectedIndex];
                    if (selectedOption && selectedOption.value) {
                    btn.textContent = selectedOption.textContent;
                    }
                }
            }

        const saboresSelect = document.getElementById('sabores');

        saboresSelect.addEventListener('mousedown', function (e) {
        e.preventDefault();

        const option = e.target;

        if (option.tagName === 'OPTION') {
            option.selected = !option.selected;
        }
        });


        async function enviarPedido(event) {
            event.preventDefault();

            const borda = document.getElementById('borda').value;
            const massa = document.getElementById('massa').value;
            const saboresSelect = document.getElementById('sabores');
            const sabores = Array.from(saboresSelect.selectedOptions).map(option => option.value);
            const messageDiv = document.getElementById('message');

            // Validações
            if (!borda || !massa || sabores.length === 0) {                
                messageDiv.className = 'alert alert-warning ';
                messageDiv.innerHTML = `
                    <strong>Atenção!</strong> Por favor, selecione borda, massa e pelo menos um sabor.
                `;
                setTimeout(() => { if (messageDiv) {
                    messageDiv.innerHTML = '';
                    messageDiv.className = '';
                }  }, 4000);
                return;
            }

            if (sabores.length > 3) {
                messageDiv.className = 'alert alert-warning';
                messageDiv.innerHTML = `
                    <strong>Atenção!</strong> Máximo 3 sabores permitidos!
                `;
                setTimeout(() => { if (messageDiv)
                    {
                        messageDiv.innerHTML = '';
                        messageDiv.className = '';
                    } 
                }, 4000);
                return;
            }

            try {
                // Passo 1: Inserir a pizza com borda e massa
                const pizzaResponse = await fetch('http://localhost:3000/api/pizzas', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        bordas_id: parseInt(borda),
                        massas_id: parseInt(massa)
                    })
                });

                if (!pizzaResponse.ok) {
                    throw new Error(`Erro ao criar pizza: ${pizzaResponse.status}`);
                }

                const pizzaResult = await pizzaResponse.json();
                const pizza_id = pizzaResult.pizza_id;

                console.log('Pizza criada com ID:', pizza_id);

                // Passo 2: Inserir cada sabor da pizza
                for (const sabor_id of sabores) {
                    const saborResponse = await fetch('http://localhost:3000/api/pizza_sabor', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            pizzas_id: pizza_id,
                            sabores_id: parseInt(sabor_id)
                        })
                    });

                    if (!saborResponse.ok) {
                        throw new Error(`Erro ao adicionar sabor: ${saborResponse.status}`);
                    }

                    console.log('Sabor', sabor_id, 'adicionado à pizza', pizza_id);
                }

                // Passo 3: Inserir o pedido
                const pedidoResponse = await fetch('http://localhost:3000/api/pedidos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pizzas_id: pizza_id,
                        status_id: 1 // Status "Em produção"
                    })
                });
                
                if (!pedidoResponse.ok) {
                    throw new Error(`Erro ao criar pedido: ${pedidoResponse.status}`);
                }

                // Sucesso: mostrar mensagem
                messageDiv.className = 'alert alert-success';
                messageDiv.innerHTML = `
                    <strong>Sucesso!</strong> Pedido enviado com sucesso! Pizza #${pizza_id} com ${sabores.length} sabor(es).
                `;
                setTimeout(() => { if (messageDiv)  
                    {   
                        messageDiv.innerHTML = '';
                        messageDiv.className = '';
                    } }, 4000);
                
                // Limpar formulário
                document.getElementById('pizza-form').reset();
            } catch (error) {
                console.error('Erro ao enviar pedido:', error);
                const messageDiv = document.getElementById('message');
                messageDiv.className = 'alert alert-danger';
                messageDiv.innerHTML = `
                    <strong>Erro!</strong> ${error.message}
                `;
                setTimeout(() => { if (messageDiv) {
                    messageDiv.innerHTML = '';
                    messageDiv.className = '';
                }  }, 4000);
            }
        }
    </script>
    <div id="footer"></div>
</body>
</html>